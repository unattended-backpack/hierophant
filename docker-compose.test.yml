services:
  hierophant:
    image: hierophant:latest
    container_name: test-hierophant
    networks:
      - test-network
    ports:
      - "9000:9000"  # gRPC
      - "9010:9010"  # HTTP + WebSocket
    environment:
      - RUST_LOG=info
      - THIS_HIEROPHANT_IP=hierophant
      - WORKER_REQUIRED_PROGRESS_INTERVAL_MINS=0
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/localhost/9010' || exit 1"]
      interval: 2s
      timeout: 2s
      retries: 30
      start_period: 5s

  contemplant:
    image: contemplant:latest
    container_name: test-contemplant
    networks:
      - test-network
    environment:
      - RUST_LOG=info
      - HIEROPHANT_WS_ADDRESS=ws://hierophant:9010/ws
      - PROVER_TYPE=cpu
    depends_on:
      hierophant:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pgrep contemplant > /dev/null || exit 1"]
      interval: 3s
      timeout: 2s
      retries: 2
      start_period: 15s

  test-client:
    build:
      context: ./src/fibonacci
      dockerfile: Dockerfile
    container_name: test-client
    networks:
      - test-network
    depends_on:
      hierophant:
        condition: service_healthy
      contemplant:
        condition: service_healthy
    environment:
      - RUST_LOG=info
    command: ["sh", "-c", "sleep 15 && cargo run --release --bin evm -- --n 10 --system plonk"]

networks:
  test-network:
    driver: bridge
